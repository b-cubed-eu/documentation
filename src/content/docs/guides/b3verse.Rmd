---
title: Welcome to the b3verse! A collection of R packages for indicator calculation
  from occurrence cubes
sidebar:
  label: The b3verse
  order: 6
knit: (function(inputFile, ...) {
  knitr::knit(
    input = inputFile,
    output = gsub("Rmd$", "md", inputFile)) })
---

<!-- b3verse.md is generated from b3verse.Rmd Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = file.path("../../../..", "public", "guides", "b3verse", "/"),
  fig.height = 4,
  dpi = 300
)
```

This guide provides an overview of the integration and maintenance of R packages designed for calculating biodiversity indicators from occurrence cubes.

Suggestion citation:

> Langeraert W, Desmet P, Van Daele T (2025). Welcome to the b3verse! A collection of R packages for indicator calculation from occurrence cubes. <https://docs.b-cubed.eu/guides/b3verse/>

<a href="https://b-cubed-eu.r-universe.dev/"><img src="/guides/b3verse/b3verse-logo.png" align="right" width="139" alt="b3verse logo" /></a>

## What is the b3verse?

The **b3verse** is a collection of related R packages that streamline indicator calculation from occurrence cubes. These packages are accessible and maintained via a [dedicated R-universe platform](https://b-cubed-eu.r-universe.dev/), ensuring continuous updates, easy distribution, and efficient [installation](#installation).

<img src="/guides/b3verse/logo-wall.png" align="center" alt="b3verse logo wall" width="600"/>

## Installation

Install all packages of the **b3verse** via this command in R:

```r
pkgs <- available.packages(repos = "https://b-cubed-eu.r-universe.dev")[, "Package"]
install.packages(pkgs, repos = "https://b-cubed-eu.r-universe.dev")
```

The following packages are currently included:

| Package | Description | GitHub repository |
| :-----: | :---------- | :---------------- |
| **rgbif** | Download occurrence cubes | <https://github.com/ropensci/rgbif> |
| **gcube** | Simulation of occurrence cubes | <https://github.com/b-cubed-eu/gcube> |
| **b3gbi** | Calculate general biodiversity indicators from occurrence cubes | <https://github.com/b-cubed-eu/b3gbi> |
| **pdindicatoR** | Calculate phylogenetic indicators from occurrence cubes | <https://github.com/b-cubed-eu/pdindicatoR> |
| **impIndicatoR** | Calculate alien impact indicators from occurrence cubes | <https://github.com/b-cubed-eu/impIndicator> |
| **dubicube** | Data exploration for occurrence cubes and uncertainty calculation for indicators | <https://github.com/b-cubed-eu/dubicube> |

Note that any dependencies not available in mainstream repositories are also added to the R-universe platform. These dependencies will be installed automatically but are not explicitly listed above.  

## Getting started
### The b3verse workflow

Occurrence cubes can be derived from GBIF data using the **rgbif** package or simulated using the **gcube** package.
They are then processed using the `process_cube()` function from the **b3gbi** package.
This ensures standardised input data across all indicator packages and verifies that the data format is correct.
Data exploration steps can be performed using **dubicube**.
Once the data cubes are processed, indicators can be calculated with **b3gbi**, **pdindicatoR** or **impIndicator**.
The **dubicube** package enables uncertainty estimation via bootstrapping. It is not a strict dependency of the indicator calculation packages, as it can also be used with custom indicator functions.

<img src="/guides/b3verse/indicator-workflow.png" align="middle" alt="indicator workflow" width="800"/>

### Example

We provide a short example of how an analysis workflow could look like using the **b3verse** packages.
We use **gcube** v1.1.2 to simulate an occurrence cube, **b3gbi** v0.4.2 to process the cube, and **dubicube** v0.3.2 to calculate uncertainty around a simple indicator.

```{r, message=FALSE}
# Load packages
library(gcube)     # simulate occurrence cubes
library(b3gbi)     # process occurrence cubes
library(dubicube)  # uncertainty calculation for occurrence cubes

library(sf)        # work with spatial objects
library(dplyr)     # data wrangling
library(ggplot2)   # data visualisation
```

**Simulate occurrence cube**

As input, we create a polygon in which we simulate occurrences.
It represents the spatial extend of the species.
We also need a grid.
Each observation will be designated to a grid cell.

```{r, fig.height=4}
# Create polygon
polygon <- st_polygon(list(cbind(c(500, 1000, 1000, 600, 200, 100, 500),
                                 c(200, 100, 700, 1000, 900, 500, 200))))

# Create grid
cube_grid <- st_make_grid(
  st_buffer(polygon, 50),
  n = c(20, 20),
  square = TRUE) %>%
  st_sf()

# Visualise
ggplot() +
  geom_sf(data = polygon) +
  geom_sf(data = cube_grid, alpha = 0) +
  theme_minimal()
```

We simulate three species for 5 time points where each species has a different average total number of occurrences at time point one and a different spatial clustering (see also [this tutoria](https://b-cubed-eu.github.io/gcube/articles/multi-species-approach.html)).

```{r}
# Create dataframe with simulation function arguments
multi_species_args <- tibble(
  species = paste("species", 1:3, sep = "_"),
  species_key = 1:3,
  species_range = rep(list(polygon), 3),
  initial_average_occurrences = c(300, 400, 500),
  n_time_points = rep(5, 3),
  temporal_function = c(NA, simulate_random_walk, NA),
  sd_step = c(NA, 10, NA),
  spatial_pattern = c("random", "clustered", "clustered"),
  coords_uncertainty_meters = 25,
  grid = rep(list(cube_grid), 3),
  seed = 123
)

# How does this dataframe look like?
glimpse(multi_species_args)
```

We simulate the datacube with these arguments.

```{r, message=FALSE, fig.height=4}
# Simulate occurrence cube
occurrence_cube_full <- multi_species_args %>%
  gcube::map_simulate_occurrences() %>%
  gcube::map_sample_observations() %>%
  gcube::map_filter_observations() %>%
  gcube::map_add_coordinate_uncertainty() %>%
  gcube::map_grid_designation(nested = FALSE)

# Select relevant columns
occurrence_cube_df <- occurrence_cube_full %>%
  select("cell_code", "time_point", "species", "species_key", "n",
         "min_coord_uncertainty")

# Visualise
occurrence_cube_df %>%
  summarise(n_obs = sum(n),
            .by = c(species, time_point)) %>%
  ggplot(aes(x = time_point, y = n_obs, colour = species)) +
  geom_point(size = 3) +
  geom_line() +
  labs(x = "time point", y = "total number of observations") +
  theme_minimal()
```

**Process occurrence cube**

We process our simulated cube using the `process_cube()` function from the **b3gbi** package.
This ensures standarisation and verifies a correct data format.

```{r}
# Process cube
processed_cube <- b3gbi::process_cube(
  cube_name = occurrence_cube_df,
  grid_type = "custom",
  cols_cellCode = "cell_code",
  cols_year = "time_point",
  cols_species = "species",
  cols_speciesKey = "species_key",
  cols_occurrences = "n",
  cols_minCoordinateUncertaintyInMeters = "min_coord_uncertainty"
)

# Content of cube
processed_cube
```

**Indicator calculation**

Finally, we calculate a simple indicator: occupancy ($O_{s,y}$) of species $s$ in year $y$.

$$
O_{s,y} = \frac{N_{s,y}}{N_{\text{total}}}
$$

where:  
- $N_{s,y}$ is the number of grid cells where species $s$ is present in year $y$
- $N_{\text{total}}$ is the total number of grid cells where any species was present in any year

```{r}
species_occupancy <- function(cube) {
  # Calculate total number of occupied cells
  total_cells <- length(unique(cube[cube$obs > 1, ]$cellCode))
  
  # Calculate proportion of occupied cells per species per year
  cube %>%
    filter(obs > 1) %>%
    summarise(diversity_val = n_distinct(cellCode) / total_cells,
              .by = c(scientificName, year))
}
```

This gives the proportion of surveyed grid cells in which the species occurs.
We use bootstrapping to calculate uncertainty around the estimates.

```{r}
bootstrap_occupancy <- dubicube::bootstrap_cube(
  data_cube = processed_cube$data,
  fun = species_occupancy,
  grouping_var = c("scientificName", "year"),
  samples = 1000,
  seed = 123
)
```



## Contributing and reporting issues

We welcome contributions to the **b3verse**! Each package in the collection has its own GitHub repository, where you can find contributing guidelines and report issues.  

**How to contribute?**
- Before contributing, check the "Contributing Guidelines" in the relevant repository (see the [table above](#installation) for links).  
- Contributions can include bug fixes, feature requests, documentation improvements, or new functionality.  

**Reporting bugs or suggesting improvements**
- If you encounter an issue or have an idea for improvement, open an "issue" in the corresponding package repository.  
- Be as detailed as possible when describing the issue, including R session info, error messages, and reproducible examples if applicable.
